<html>
    <head>
        <meta charset="utf-8">
        <title></title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">


        <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.3.5/angular-route.min.js"></script>
        <script>
        var app = angular.module('app', []);

        app.factory('PeopleFactory', function($http) {
            var people = []
            var factory = {};

            factory.get = function(callback) {
                $http.get('/people').then(function(res) {
                    people = res.data;
                    callback(people);
                })
            }
            factory.create = function(person, callback) {
                $http.post('/people', person).then(function(res) {
                    callback(res);
                })
            }
            factory.delete = function(person, callback) {
                $http.delete('/people/'+person._id).then(function(res) {
                    console.log(res);
                    callback(res);
                })
            }

            return factory;
        })

        app.controller('PeopleController', function($scope, PeopleFactory) {
            console.log('People Controller loaded');
            $scope.people = [];

            PeopleFactory.get(function(data) {
                $scope.people = data;
            })

            $scope.create = function() {
                PeopleFactory.create($scope.newPerson, function(data) {
                    PeopleFactory.get(function(data) {
                        $scope.people = data;
                        $scope.newPerson = {};
                    })
                })
            }

            $scope.delete = function(person) {
                PeopleFactory.delete(person, function(data) {
                    console.log('Factory done');
                    PeopleFactory.get(function(data) {
                        $scope.people = data;
                    })
                })
            }

        })
        </script>
        <style>
        button {
            width: 100%;
        }
        </style>
    </head>
    <body ng-app="app">
        <div ng-controller="PeopleController" class="container">
            <form ng-submit="create()">
                <div class="row">
                    <div class="col s4">First Name</div>
                    <div class="col s8"><input type="text" ng-model="newPerson.firstName"></div>
                </div>
                <div class="row">
                    <div class="col s4">Last Name</div>
                    <div class="col s8"><input type="text" ng-model="newPerson.lastName"></div>
                </div>
                <div class="row">
                    <div class="col s4">Age</div>
                    <div class="col s8"><input type="number" ng-model="newPerson.age"></div>
                </div>
                <div class="row">
                    <div class="col s12"><input type="submit"></div>
                </div>
            </form>

            <table>
                <thead>
                    <tr>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Age</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="person in people">
                        <td ng-bind="person.firstName"></td>
                        <td ng-bind="person.lastName"></td>
                        <td ng-bind="person.age"></td>
                        <td><button class="btn waves-effect" ng-click="delete(person)">X</button></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/js/materialize.min.js'></script>
    </body>
</html>
